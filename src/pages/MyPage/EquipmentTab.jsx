import React, { useState, useMemo, useRef } from "react";
import "./EquipmentTab.css";
import warriorSilhouette from "../../assets/warrior-silhouette.png";
import { FaUser, FaChartBar } from "react-icons/fa";
import { GiBackpack } from "react-icons/gi";

function EquipmentTab() {
  const [equipped, setEquipped] = useState({
    helmet: null,
    armor: null,
    pants: null,
    mainWeapon: null,
    subWeapon: null,
  });

  const [inventory] = useState([
    { id: "h1", type: "helmet", name: "Í∞ïÏ≤† Ìà¨Íµ¨", desc: "Îã®Îã®Ìïú Í∞ïÏ≤†Î°ú Ï†úÏûëÎêú Ìà¨Íµ¨", atk: 0, def: 8, hp: 15, icon: "‚õëÔ∏è" },
    { id: "h2", type: "helmet", name: "Í∞ÄÏ£Ω Î™®Ïûê", desc: "Î∂ÄÎìúÎü¨Ïö¥ Í∞ÄÏ£Ω Î™®Ïûê", atk: 0, def: 3, hp: 8, icon: "üé©" },
    { id: "h3", type: "helmet", name: "ÎßàÎ≤ïÏÇ¨Ïùò Î™®Ïûê", desc: "Ïã†ÎπÑÌïú ÌûòÏù¥ ÍπÉÎì† Î™®Ïûê", atk: 2, def: 2, hp: 10, icon: "üßô" },
    { id: "h4", type: "helmet", name: "ÏôïÍ¥Ä", desc: "ÌôîÎ†§Ìïú Í∏àÎπõ ÏôïÍ¥Ä", atk: 0, def: 5, hp: 20, icon: "üëë" },
    
    { id: "a1", type: "armor", name: "Í∏∞ÏÇ¨Ïùò ÌùâÍ∞ë", desc: "Ï§ëÏû•Í∞ë Í∏∞ÏÇ¨Ïö© Í∞ëÏò∑", atk: 0, def: 20, hp: 30, icon: "üõ°Ô∏è" },
    { id: "a2", type: "armor", name: "Ï≤ú Í∞ëÏò∑", desc: "Í∞ÄÎ≤ºÏö¥ Ï≤ú Ïû¨ÏßàÏùò Í∞ëÏò∑", atk: 0, def: 8, hp: 15, icon: "üëï" },
    { id: "a3", type: "armor", name: "Ïö©Ïùò ÎπÑÎäò Í∞ëÏò∑", desc: "Ï†ÑÏÑ§Ïùò ÎìúÎûòÍ≥§ ÎπÑÎäòÎ°ú Ï†úÏûë", atk: 5, def: 25, hp: 40, icon: "üêâ" },
    { id: "a4", type: "armor", name: "Í∞ÄÏ£Ω Í∞ëÏò∑", desc: "ÌäºÌäºÌïú Í∞ÄÏ£Ω Í∞ëÏò∑", atk: 0, def: 12, hp: 20, icon: "üß•" },
    
    { id: "p1", type: "pants", name: "ÏÇ¨ÎÉ•ÍæºÏùò Í∞ÅÎ∞ò", desc: "ÎØºÏ≤©ÏÑ±ÏùÑ ÎÜíÏó¨Ï£ºÎäî Í∞ÅÎ∞ò", atk: 0, def: 10, hp: 12, icon: "üëñ" },
    { id: "p2", type: "pants", name: "Í∞ÄÏ£Ω Î∞îÏßÄ", desc: "Ìé∏ÏïàÌïú Í∞ÄÏ£Ω Î∞îÏßÄ", atk: 0, def: 6, hp: 8, icon: "üëñ" },
    { id: "p3", type: "pants", name: "Í∞ïÏ≤† Í∞ÅÎ∞ò", desc: "Î¨¥Í±∞Ïö¥ Í∞ïÏ≤† Í∞ÅÎ∞ò", atk: 0, def: 15, hp: 18, icon: "ü¶ø" },
    
    { id: "m1", type: "mainWeapon", name: "Î°±ÏÜåÎìú", desc: "Í∏¥ Í≤ÄÏã†Ïùò ÏñëÏÜêÍ≤Ä", atk: 18, def: 0, hp: 0, icon: "‚öîÔ∏è" },
    { id: "m2", type: "mainWeapon", name: "Îã®Í≤Ä", desc: "Îπ†Î•∏ Í≥µÍ≤©Ïù¥ Í∞ÄÎä•Ìïú Îã®Í≤Ä", atk: 10, def: 0, hp: 0, icon: "üó°Ô∏è" },
    { id: "m3", type: "mainWeapon", name: "ÎåÄÍ≤Ä", desc: "ÏóÑÏ≤≠ÎÇú ÏúÑÎ†•Ïùò ÎåÄÍ≤Ä", atk: 25, def: 0, hp: 0, icon: "‚öîÔ∏è" },
    { id: "m4", type: "mainWeapon", name: "ÎßàÎ≤ï ÏßÄÌå°Ïù¥", desc: "ÎßàÎ≤ï Í≥µÍ≤©Î†•Ïù¥ Í∞ïÌïú ÏßÄÌå°Ïù¥", atk: 15, def: 0, hp: 0, icon: "ü™Ñ" },
    { id: "m5", type: "mainWeapon", name: "Ìôú", desc: "ÏõêÍ±∞Î¶¨ Í≥µÍ≤© Î¨¥Í∏∞", atk: 12, def: 0, hp: 0, icon: "üèπ" },
    
    { id: "s1", type: "subWeapon", name: "Í∞ïÏ≤† Î∞©Ìå®", desc: "Îì†Îì†Ìïú Í∞ïÏ≤† Î∞©Ìå®", atk: 0, def: 18, hp: 10, icon: "üõ°Ô∏è" },
    { id: "s2", type: "subWeapon", name: "ÎÇòÎ¨¥ Î∞©Ìå®", desc: "Í∞ÄÎ≤ºÏö¥ ÎÇòÎ¨¥ Î∞©Ìå®", atk: 0, def: 8, hp: 5, icon: "ü™µ" },
    { id: "s3", type: "subWeapon", name: "ÎßàÎ≤ï Ï±Ö", desc: "Î≥¥Ï°∞ ÎßàÎ≤ïÏÑú", atk: 5, def: 5, hp: 0, icon: "üìñ" },
    { id: "s4", type: "subWeapon", name: "ÌôîÏÇ¥ÌÜµ", desc: "ÌôîÏÇ¥ÏùÑ Îã¥Îäî ÌÜµ", atk: 3, def: 2, hp: 0, icon: "üèπ" },
    { id: "s5", type: "subWeapon", name: "ÎπõÎÇòÎäî Í≤Ä", desc: "ÌäπÎ≥ÑÌïú Î¨¥Í∏∞", atk: 8, def: 3, hp: 5, icon: "‚ú®" },
    { id: "s6", type: "subWeapon", name: "Ìôú", desc: "ÌôúÍ≥º ÌôîÏÇ¥", atk: 6, def: 1, hp: 0, icon: "üèπ" },
  ]);

  const [hoveredItem, setHoveredItem] = useState(null);
  const [tooltipPosition, setTooltipPosition] = useState({ 
    top: 0, 
    left: 0, 
    position: 'below-center'
  });
  const inventoryGridRef = useRef(null);

  // Í∏∞Î≥∏ Ïä§ÌÉØ
  const baseStats = {
    hp: 100,
    atk: 10,
    def: 5,
    cri: 12.5,
    crid: 1.8,
    spd: 7,
    jmp: 5,
  };

  // Ïû•ÎπÑÎ°ú Ïù∏Ìïú Ï∂îÍ∞Ä Ïä§ÌÉØ Í≥ÑÏÇ∞
  const equipmentStats = useMemo(() => {
    const bonus = { hp: 0, atk: 0, def: 0 };
    
    Object.values(equipped).forEach((item) => {
      if (item) {
        bonus.hp += item.hp || 0;
        bonus.atk += item.atk || 0;
        bonus.def += item.def || 0;
      }
    });
    
    return bonus;
  }, [equipped]);

  // ÏµúÏ¢Ö Ïä§ÌÉØ Í≥ÑÏÇ∞
  const playerStats = {
    hp: baseStats.hp + equipmentStats.hp,
    atk: baseStats.atk + equipmentStats.atk,
    def: baseStats.def + equipmentStats.def,
    cri: baseStats.cri,
    crid: baseStats.crid,
    spd: baseStats.spd,
    jmp: baseStats.jmp,
  };

  const handleEquip = (item) => {
    setEquipped((prev) => {
      const currentItem = prev[item.type];
      
      if (currentItem?.id === item.id) {
        return {
          ...prev,
          [item.type]: null,
        };
      }
      
      return {
        ...prev,
        [item.type]: item,
      };
    });
  };

  const handleUnequip = (slotKey) => {
    if (equipped[slotKey]) {
      setEquipped((prev) => ({
        ...prev,
        [slotKey]: null,
      }));
    }
  };

  const handleMouseEnter = (item, event) => {
    const target = event.currentTarget;
    const rect = target.getBoundingClientRect();
    const container = inventoryGridRef.current;
    
    if (container) {
      const containerRect = container.getBoundingClientRect();
      const scrollTop = container.scrollTop;
      
      const relativeTop = rect.top - containerRect.top + scrollTop;
      const relativeLeft = rect.left - containerRect.left;
      
      const tooltipWidth = 220;
      const tooltipHeight = 130;
      
      const containerWidth = container.scrollWidth;
      const containerHeight = container.scrollHeight;
      
      const spaceAbove = relativeTop;
      const spaceBelow = containerHeight - relativeTop - rect.height;
      const spaceLeft = relativeLeft;
      const spaceRight = containerWidth - relativeLeft - rect.width;
      
      let position = 'below-center';
      let top = relativeTop + rect.height + 10;
      let left = relativeLeft + rect.width / 2;
      
      if (spaceBelow >= tooltipHeight) {
        position = 'below-center';
        top = relativeTop + rect.height + 10;
        left = relativeLeft + rect.width / 2;
        
        if (left - tooltipWidth / 2 < 20) {
          position = 'below-left';
          left = relativeLeft;
        } else if (left + tooltipWidth / 2 > containerWidth - 20) {
          position = 'below-right';
          left = relativeLeft + rect.width;
        }
      } else if (spaceAbove >= tooltipHeight) {
        position = 'above-center';
        top = relativeTop - 10;
        left = relativeLeft + rect.width / 2;
        
        if (left - tooltipWidth / 2 < 20) {
          position = 'above-left';
          left = relativeLeft;
        } else if (left + tooltipWidth / 2 > containerWidth - 20) {
          position = 'above-right';
          left = relativeLeft + rect.width;
        }
      } else if (spaceRight >= tooltipWidth) {
        position = 'right-center';
        top = relativeTop + rect.height / 2;
        left = relativeLeft + rect.width + 10;
      } else if (spaceLeft >= tooltipWidth) {
        position = 'left-center';
        top = relativeTop + rect.height / 2;
        left = relativeLeft - 10;
      } else {
        const maxSpace = Math.max(spaceBelow, spaceAbove, spaceLeft, spaceRight);
        
        if (maxSpace === spaceBelow || maxSpace === spaceAbove) {
          position = maxSpace === spaceBelow ? 'below-center' : 'above-center';
          top = maxSpace === spaceBelow ? relativeTop + rect.height + 10 : relativeTop - 10;
          left = relativeLeft + rect.width / 2;
        } else {
          position = maxSpace === spaceRight ? 'right-center' : 'left-center';
          top = relativeTop + rect.height / 2;
          left = maxSpace === spaceRight ? relativeLeft + rect.width + 10 : relativeLeft - 10;
        }
      }
      
      setHoveredItem(item);
      setTooltipPosition({ top, left, position });
    }
  };

  const handleMouseLeave = () => {
    setHoveredItem(null);
  };

  const Slot = ({ slotKey, label }) => {
    const item = equipped[slotKey];
    
    return (
      <div
        className={`equip-slot ${slotKey}`}
        onDoubleClick={() => handleUnequip(slotKey)}
        onMouseEnter={(e) => item && handleMouseEnter(item, e)}
        onMouseLeave={handleMouseLeave}
      >
        <div className="slot-label">{label}</div>
        {item ? (
          <div className="slot-icon">{item.icon}</div>
        ) : (
          <div className="slot-empty">ÎπÑÏñ¥ ÏûàÏùå</div>
        )}
      </div>
    );
  };

  return (
    <div className="equipment-ui">
      {/* ÏôºÏ™Ω: Ïû•ÎπÑ + Ïä§ÌÉØ */}
      <section className="left-panel">
        <div className="character-panel">
          <h2><FaUser style={{ marginRight: '8px' }} />Ïû•ÎπÑÏ∞Ω</h2>
          <div className="character-container">
            <div className="character-figure">
              <img 
                src={warriorSilhouette} 
                alt="Ï†ÑÏÇ¨ Ïã§Î£®Ïó£" 
                className="warrior-image"
              />
            </div>

            <Slot slotKey="helmet" label="Ìó¨Î©ß" />
            <Slot slotKey="armor" label="Í∞ëÏò∑" />
            <Slot slotKey="pants" label="Î∞îÏßÄ" />
            <Slot slotKey="mainWeapon" label="Ï£ºÎ¨¥Í∏∞" />
            <Slot slotKey="subWeapon" label="Î≥¥Ï°∞Î¨¥Í∏∞" />
          </div>
        </div>

        <div className="stats-panel">
          <h2><FaChartBar style={{ marginRight: '8px' }} />Ïä§ÌÉØ</h2>
          <div className="stats-list">
            <div>HP</div>
            <div>
              {playerStats.hp}
              {equipmentStats.hp > 0 && (
                <span className="stat-bonus"> (+{equipmentStats.hp})</span>
              )}
            </div>
            
            <div>ATK</div>
            <div>
              {playerStats.atk}
              {equipmentStats.atk > 0 && (
                <span className="stat-bonus"> (+{equipmentStats.atk})</span>
              )}
            </div>
            
            <div>DEF</div>
            <div>
              {playerStats.def}
              {equipmentStats.def > 0 && (
                <span className="stat-bonus"> (+{equipmentStats.def})</span>
              )}
            </div>
            
            <div>CRI</div><div>{playerStats.cri}%</div>
            <div>CRID</div><div>{playerStats.crid}x</div>
            <div>SPD</div><div>{playerStats.spd}</div>
            <div>JMP</div><div>{playerStats.jmp}</div>
          </div>
        </div>
      </section>

      {/* Ïò§Î•∏Ï™Ω: Ïù∏Î≤§ÌÜ†Î¶¨ */}
      <section className="right-panel">
        <div className="inventory-header">
          <h2><GiBackpack style={{ marginRight: '8px' }} />Ïù∏Î≤§ÌÜ†Î¶¨</h2>
        </div>
        <div className="inventory-grid-wrapper">
          <div className="inventory-grid" ref={inventoryGridRef}>
            {/* Ìà¥ÌåÅ - Ïù∏Î≤§ÌÜ†Î¶¨ Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä */}
            {hoveredItem && (
              <div
                className={`item-tooltip tooltip-${tooltipPosition.position}`}
                style={{
                  top: `${tooltipPosition.top}px`,
                  left: `${tooltipPosition.left}px`,
                }}
              >
                <div className="tooltip-name">{hoveredItem.name}</div>
                <div className="tooltip-desc">{hoveredItem.desc}</div>
                <div className="tooltip-stats">
                  {hoveredItem.hp > 0 && <div className="stat-hp">HP +{hoveredItem.hp}</div>}
                  {hoveredItem.atk > 0 && <div className="stat-atk">ATK +{hoveredItem.atk}</div>}
                  {hoveredItem.def > 0 && <div className="stat-def">DEF +{hoveredItem.def}</div>}
                </div>
              </div>
            )}
            
            {inventory.length > 0 ? (
              inventory.map((item) => {
                const isEquipped = equipped[item.type]?.id === item.id;
                
                return (
                  <div
                    key={item.id}
                    className={`inventory-slot ${isEquipped ? "equipped" : ""}`}
                    onClick={() => handleEquip(item)}
                    onMouseEnter={(e) => handleMouseEnter(item, e)}
                    onMouseLeave={handleMouseLeave}
                  >
                    <div className="item-icon">{item.icon}</div>
                    {isEquipped && <div className="equipped-badge">E</div>}
                  </div>
                );
              })
            ) : (
              <p className="empty">Î≥¥Ïú† ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>
            )}
          </div>
        </div>
      </section>
    </div>
  );
}

export default EquipmentTab;